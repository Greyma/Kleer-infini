name: ğŸš€ DevOps Pipeline - Garoui ElectricitÃ©

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ============ PHASE TESTS ============
  tests:
    name: ğŸ§ª Tests automatiques
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Installation Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        npm ci
        echo "âœ… DÃ©pendances installÃ©es"
        
    - name: ğŸ§ª ExÃ©cution des tests
      run: |
        npm test
        echo "âœ… Tests DevOps rÃ©ussis"
        
    - name: ğŸ” Audit de sÃ©curitÃ©
      run: |
        npm audit --audit-level=high
        echo "âœ… Audit sÃ©curitÃ© terminÃ©"
        
    - name: ğŸ—ï¸ Test de build
      run: |
        npm run build
        echo "âœ… Build validÃ©"

  # ============ PHASE DÃ‰PLOIEMENT ============
  deploy:
    name: ğŸš€ DÃ©ploiement Production
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: ğŸš€ DÃ©ploiement sur Render.com
      run: |
        echo "ğŸš€ DÃ©ploiement automatique dÃ©clenchÃ©"
        echo "âœ… Render.com va rÃ©cupÃ©rer le code automatiquement"
        echo "ğŸ”— URL de production sera disponible aprÃ¨s dÃ©ploiement"
        
    - name: â±ï¸ Attente stabilisation (30s)
      run: sleep 30
      
    - name: ğŸ¥ Test de santÃ© en production
      run: |
        echo "ğŸ¥ Tests de santÃ© seront configurÃ©s aprÃ¨s dÃ©ploiement Render"
        echo "âœ… Pipeline de dÃ©ploiement terminÃ©"

  # ============ NOTIFICATION ============
  notify:
    name: ğŸ“¢ Notifications
    needs: [tests, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: âœ… SuccÃ¨s complet
      if: needs.tests.result == 'success' && needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ SUCCÃˆS COMPLET !"
        echo "âœ… Tests passÃ©s sur toutes les versions Node.js"
        echo "âœ… DÃ©ploiement rÃ©ussi sur Render.com"
        echo "âœ… Application prÃªte en production"
        
    - name: âŒ Ã‰chec dÃ©tectÃ©
      if: needs.tests.result != 'success' || needs.deploy.result != 'success'
      run: |
        echo "âŒ Ã‰CHEC DÃ‰TECTÃ‰"
        echo "Tests: ${{ needs.tests.result }}"
        echo "Deploy: ${{ needs.deploy.result }}"
        echo "VÃ©rifiez les logs ci-dessus"