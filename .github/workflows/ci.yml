name: ğŸš€ DevOps Pipeline - Garoui ElectricitÃ©

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PRODUCTION_URL: https://kleer-infini.onrender.com

jobs:
  # ============ PHASE TESTS LOCAUX ============
  tests:
    name: ğŸ§ª Tests automatiques
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Installation Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        npm ci
        echo "âœ… DÃ©pendances installÃ©es"
        
    - name: ğŸ§ª ExÃ©cution des tests
      run: |
        npm test
        echo "âœ… Tests DevOps rÃ©ussis"
        
    - name: ğŸ” Audit de sÃ©curitÃ©
      run: |
        npm audit --audit-level=high
        echo "âœ… Audit sÃ©curitÃ© terminÃ©"
        
    - name: ğŸ—ï¸ Test de build
      run: |
        npm run build
        echo "âœ… Build validÃ©"

  # ============ PHASE DÃ‰PLOIEMENT ============
  deploy:
    name: ğŸš€ DÃ©ploiement Production
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©ration du code
      uses: actions/checkout@v4
      
    - name: ğŸš€ DÃ©ploiement sur Render.com
      run: |
        echo "ğŸš€ DÃ©ploiement automatique dÃ©clenchÃ©"
        echo "âœ… Render.com va rÃ©cupÃ©rer le code automatiquement"
        echo "ğŸ”— URL de production: ${{ env.PRODUCTION_URL }}"
        
    - name: â±ï¸ Attente dÃ©ploiement (90s)
      run: |
        echo "â±ï¸ Attente que Render dÃ©ploie les changements..."
        sleep 90

  # ============ TESTS EN PRODUCTION ============
  production-tests:
    name: ğŸŒ Tests en production
    needs: [tests, deploy]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:      
    - name: ğŸ¥ Test endpoint de santÃ©
      run: |
        echo "ğŸ§ª Test de l'endpoint de santÃ© en production..."
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health)
        echo "Code de rÃ©ponse: $response"
        
        if [ $response -eq 200 ]; then
          echo "âœ… Endpoint /api/health rÃ©pond correctement (200)"
        else
          echo "âŒ Endpoint /api/health Ã©choue (code: $response)"
          echo "ğŸ”„ Tentative de rÃ©veil du service (Render peut Ãªtre en veille)..."
          sleep 30
          response2=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health)
          if [ $response2 -eq 200 ]; then
            echo "âœ… Service rÃ©veillÃ© avec succÃ¨s !"
          else
            echo "âŒ Service toujours inaccessible"
            exit 1
          fi
        fi
        
    - name: ğŸ“ Test endpoint ping
      run: |
        echo "ğŸ§ª Test de l'endpoint ping..."
        response=$(curl -s ${{ env.PRODUCTION_URL }}/api/ping || echo "CURL_FAILED")
        echo "RÃ©ponse reÃ§ue: $response"
        
        if echo "$response" | grep -q "pong"; then
          echo "âœ… Endpoint /api/ping rÃ©pond 'pong'"
        else
          echo "âŒ Endpoint /api/ping ne rÃ©pond pas correctement"
          exit 1
        fi
        
    - name: âš¡ Test temps de rÃ©ponse
      run: |
        echo "ğŸ§ª Test du temps de rÃ©ponse..."
        start_time=$(date +%s%N)
        curl -s ${{ env.PRODUCTION_URL }}/api/ping > /dev/null
        end_time=$(date +%s%N)
        
        duration=$(( (end_time - start_time) / 1000000 ))
        echo "â±ï¸ Temps de rÃ©ponse: ${duration}ms"
        
        if [ $duration -lt 3000 ]; then
          echo "âœ… Temps de rÃ©ponse acceptable (< 3s)"
        else
          echo "âš ï¸ Temps de rÃ©ponse Ã©levÃ© (> 3s) mais acceptable pour Render gratuit"
        fi
        
    - name: ğŸ” Test structure rÃ©ponse health
      run: |
        echo "ğŸ§ª Test de la structure de /api/health..."
        response=$(curl -s ${{ env.PRODUCTION_URL }}/api/health)
        echo "RÃ©ponse health complÃ¨te:"
        echo "$response"
        
        if echo "$response" | grep -q '"status":"UP"'; then
          echo "âœ… Status UP dÃ©tectÃ©"
        else
          echo "âŒ Status UP non trouvÃ©"
          exit 1
        fi
        
        if echo "$response" | grep -q "Garoui"; then
          echo "âœ… Service name Garoui dÃ©tectÃ©"
        else
          echo "âŒ Service name Garoui non trouvÃ©"
          exit 1
        fi
        
        echo "âœ… Tests en production rÃ©ussis !"

  # ============ NOTIFICATION DEVOPS ============
  notify:
    name: ğŸ“¢ RÃ©sumÃ© DevOps
    needs: [tests, deploy, production-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Rapport final
      run: |
        echo "========================================="
        echo "ğŸ¯ RAPPORT DEVOPS - Garoui ElectricitÃ©"
        echo "========================================="
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— URL Production: ${{ env.PRODUCTION_URL }}"
        echo ""
        echo "ğŸ“Š RÃ‰SULTATS:"
        echo "Tests locaux: ${{ needs.tests.result }}"
        echo "DÃ©ploiement: ${{ needs.deploy.result }}"
        echo "Tests production: ${{ needs.production-tests.result }}"
        echo ""
        
        if [ "${{ needs.tests.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ] && [ "${{ needs.production-tests.result }}" == "success" ]; then
          echo "ğŸ‰ âœ… SUCCÃˆS COMPLET !"
          echo "âœ… Application dÃ©ployÃ©e et fonctionnelle"
          echo "âœ… Tous les tests passent"
          echo "âœ… API accessible en production"
          echo ""
          echo "ğŸ”— Endpoints disponibles:"
          echo "- Health: ${{ env.PRODUCTION_URL }}/api/health"
          echo "- Ping: ${{ env.PRODUCTION_URL }}/api/ping"
          echo "- Status: ${{ env.PRODUCTION_URL }}/api/status"
          echo ""
          echo "ğŸ”„ Monitoring UptimeRobot configurÃ©"
        else
          echo "âŒ PROBLÃˆME DÃ‰TECTÃ‰"
          echo "VÃ©rifiez les logs ci-dessus"
          
          if [ "${{ needs.tests.result }}" != "success" ]; then
            echo "- Tests locaux en Ã©chec"
          fi
          if [ "${{ needs.deploy.result }}" != "success" ]; then
            echo "- DÃ©ploiement en Ã©chec"
          fi
          if [ "${{ needs.production-tests.result }}" != "success" ]; then
            echo "- Tests production en Ã©chec"
          fi
        fi